# Деплой Flipbook на Amvera Cloud + Cloud.ru S3

Пошаговая инструкция от регистрации до работающего сайта.

**Что получится в итоге:**
- Сервер (Express + фронтенд) — на Amvera Cloud
- База данных (PostgreSQL) — на Amvera Cloud
- Хранилище файлов (S3) — на Cloud.ru (бесплатно, 15 ГБ)
- Бесплатный домен с HTTPS от Amvera

**Стоимость:**
- Amvera: 111 руб. стартового баланса бесплатно, потом ~580 руб/мес (сервер + БД)
- Cloud.ru S3: бесплатно (15 ГБ навсегда)

---

## Часть 1. Cloud.ru — S3-хранилище для файлов

Начинаем с Cloud.ru, потому что ключи S3 понадобятся при настройке сервера.

### Шаг 1.1. Регистрация на Cloud.ru

1. Открой https://cloud.ru/offers/free-tier
2. Нажми **«Попробовать бесплатно»** (или «Регистрация»)
3. Введи email и придумай пароль
4. Подтверди email (придёт письмо, кликни ссылку)
5. Заполни данные (имя, телефон)
6. После регистрации попадёшь в консоль Cloud.ru

### Шаг 1.2. Создай проект (если не создан автоматически)

1. В консоли Cloud.ru слева выбери **«Все проекты»**
2. Если проектов нет — нажми **«Создать проект»**
3. Назови его как угодно, например `flipbook`
4. Нажми **«Создать»**
5. Кликни на созданный проект, чтобы войти в него

### Шаг 1.3. Создай бакет (хранилище)

1. В левом меню найди **«Object Storage»** (или через поиск сервисов)
2. Нажми **«Создать бакет»**
3. Заполни:
   - **Имя бакета:** `flipbook-uploads` (только строчные буквы, цифры, дефисы)
   - **Класс хранения:** Стандартный
   - Остальное оставь по умолчанию
4. Нажми **«Создать»**

### Шаг 1.4. Включи публичный доступ на чтение

Чтобы браузер мог загружать картинки и шрифты из хранилища:

1. Открой созданный бакет `flipbook-uploads`
2. Перейди в **«Настройки»** (или «Settings»)
3. Найди секцию **«Публичный доступ»** (Public access)
4. Включи **«Чтение объектов»** (GET)
5. Сохрани изменения

### Шаг 1.5. Создай API-ключи

1. Нажми на свои инициалы в правом верхнем углу → **«Мой профиль»**
2. Перейди в раздел **«Ключи доступа»** (или API Keys)
3. Нажми **«Создать ключ»** (или «Сгенерировать»)
4. Появятся два значения:
   ```
   Key ID:     AKIAIOSFODNN7EXAMPLE
   Key Secret: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
   ```
5. **СКОПИРУЙ ОБА ЗНАЧЕНИЯ СЕЙЧАС!** Key Secret покажут только один раз!
6. Сохрани их в надёжное место (заметки, менеджер паролей)

### Шаг 1.6. Запиши все данные

Теперь у тебя есть всё для S3. Запиши в блокнот:

```
S3_ENDPOINT=https://s3.cloud.ru
S3_BUCKET=flipbook-uploads
S3_REGION=ru-1
S3_ACCESS_KEY=<Key ID из шага 1.5>
S3_SECRET_KEY=<Key Secret из шага 1.5>
S3_FORCE_PATH_STYLE=true
S3_PUBLIC_URL=https://s3.cloud.ru/flipbook-uploads
```

> **Примечание:** Точный endpoint и регион могут отличаться — проверь
> в документации Cloud.ru или в настройках бакета. Там же будет виден
> публичный URL бакета.

---

## Часть 2. Amvera Cloud — сервер и база данных

### Шаг 2.1. Регистрация на Amvera

1. Открой https://amvera.ru
2. Нажми **«Регистрация»** (правый верхний угол)
3. Введи email, придумай пароль, введи имя пользователя (логин)
4. Подтверди номер телефона (придёт SMS)
5. После регистрации на балансе появится **111 руб.** — этого хватит на ~3 недели
6. Ты попадёшь на страницу **«Проекты»**

### Шаг 2.2. Создай базу данных PostgreSQL

1. На странице проектов нажми **«Создать»**
2. Выбери тип: **«PostgreSQL»** (не «Приложение»!)
3. Заполни:
   - **Название проекта:** `flipbook-db` (латиницей, без пробелов)
   - **Тариф:** Начальный (0.25 CPU, 512 МБ RAM) — для стабильной работы
     - Или «Пробный» (0.1 CPU, 100 МБ RAM) — для экономии на тесте
4. Нажми **«Далее»**
5. Заполни параметры базы данных:
   - **Имя базы данных:** `flipbook`
   - **Имя пользователя:** `flipbook`
   - **Пароль:** придумай и **запиши!** Например: `MyDbPass123!`
6. Нажми **«Завершить»**
7. Подожди, пока статус станет **«PostgreSQL запущен»** (1–3 минуты)

### Шаг 2.3. Найди хост базы данных

1. Открой проект `flipbook-db`
2. Перейди на вкладку **«Инфо»**
3. Найди **внутреннее доменное имя** — оно выглядит примерно так:
   ```
   amvera-ТВОЙЛОГИН-cnpg-flipbook-db-rw
   ```
4. **Запиши его** — это хост для подключения

### Шаг 2.4. Собери DATABASE_URL

Из данных шагов 2.2 и 2.3 собери строку подключения:

```
postgresql://flipbook:MyDbPass123!@amvera-ТВОЙЛОГИН-cnpg-flipbook-db-rw:5432/flipbook?sslmode=disable
```

Формат: `postgresql://ПОЛЬЗОВАТЕЛЬ:ПАРОЛЬ@ХОСТ:5432/БАЗА?sslmode=disable`

> `sslmode=disable` — обязательно для подключения внутри Amvera (между проектами).

---

### Шаг 2.5. Создай проект для сервера

1. Вернись на страницу **«Проекты»**
2. Нажми **«Создать»**
3. Выбери тип: **«Приложение»**
4. Заполни:
   - **Название проекта:** `flipbook` (латиницей)
   - **Тариф:** Начальный (0.25 CPU, 512 МБ RAM)
     - Или «Пробный» для теста
5. Метод загрузки: **«Через Git»**
6. Нажми **«Завершить»**

### Шаг 2.6. Добавь переменные окружения

**Это самый важный шаг! Без переменных сервер не запустится.**

1. Открой проект `flipbook`
2. Перейди на вкладку **«Переменные»**
3. Для каждой переменной: нажми **«Создать переменную»** и заполни имя и значение

**Обычные переменные (тип: переменная):**

| Имя | Значение |
|-----|----------|
| `NODE_ENV` | `production` |
| `PORT` | `4000` |
| `SESSION_SECURE` | `true` |
| `S3_BUCKET` | `flipbook-uploads` |
| `S3_REGION` | `ru-1` |
| `S3_FORCE_PATH_STYLE` | `true` |

**Секреты (тип: секрет) — для конфиденциальных данных:**

| Имя | Значение |
|-----|----------|
| `DATABASE_URL` | `postgresql://flipbook:MyDbPass123!@amvera-ТВОЙЛОГИН-cnpg-flipbook-db-rw:5432/flipbook?sslmode=disable` |
| `SESSION_SECRET` | *(случайная строка, минимум 32 символа — сгенерируй командой ниже)* |
| `S3_ENDPOINT` | `https://s3.cloud.ru` |
| `S3_ACCESS_KEY` | *(Key ID из шага 1.5)* |
| `S3_SECRET_KEY` | *(Key Secret из шага 1.5)* |
| `S3_PUBLIC_URL` | `https://s3.cloud.ru/flipbook-uploads` |

> **Как сгенерировать SESSION_SECRET:**
> Открой терминал и выполни:
> ```bash
> node -e "console.log(require('crypto').randomBytes(48).toString('base64url'))"
> ```
> Или на Python:
> ```bash
> python3 -c "import secrets; print(secrets.token_urlsafe(48))"
> ```
> Скопируй результат — это и будет твой SESSION_SECRET.

**Переменные, которые нужно добавить ПОСЛЕ получения домена (шаг 2.9):**

| Имя | Значение |
|-----|----------|
| `CORS_ORIGIN` | `https://flipbook-ТВОЙЛОГИН.amvera.io` |
| `APP_URL` | `https://flipbook-ТВОЙЛОГИН.amvera.io` |
| `GOOGLE_CALLBACK_URL` | `https://flipbook-ТВОЙЛОГИН.amvera.io/api/auth/google/callback` |

> CORS_ORIGIN и APP_URL — добавишь позже, когда узнаешь свой домен (шаг 2.9).
> Без них сервер запустится, но авторизация не будет работать корректно.

### Шаг 2.7. Подключи Git-репозиторий

Открой терминал в папке проекта Flipbook и выполни:

```bash
# Добавь Amvera как remote (URL виден во вкладке «Репозиторий» проекта)
git remote add amvera https://git.amvera.ru/ТВОЙЛОГИН/flipbook

# Запуши код
git push amvera main
```

> При первом пуше спросит логин и пароль — введи данные от аккаунта Amvera.
>
> Если ветка называется `master`, а не `main`:
> ```bash
> git push amvera master
> ```
>
> Если ошибка «failed to push some refs» — выполни сначала:
> ```bash
> git pull amvera main --allow-unrelated-histories
> ```

### Шаг 2.8. Наблюдай за сборкой

1. В интерфейсе Amvera открой проект `flipbook`
2. Перейди на вкладку **«Лог сборки»** — увидишь, как Docker собирает образ
3. Сборка занимает 3–7 минут (multi-stage: фронтенд + бэкенд)
4. После сборки перейди на **«Лог приложения»** — увидишь запуск сервера
5. Жди статуса **«Приложение запущено»**

> Если в логах ошибка — скорее всего, проблема в переменных окружения.
> Проверь DATABASE_URL (правильный хост, пароль) и другие переменные.

### Шаг 2.9. Включи домен

1. Перейди на вкладку **«Настройки»** проекта `flipbook`
2. Найди секцию **«Доменное имя»**
3. Включи тумблер **«Бесплатный домен»**
4. Amvera покажет URL, например:
   ```
   https://flipbook-ТВОЙЛОГИН.amvera.io
   ```
5. **Скопируй этот URL**

### Шаг 2.10. Добавь CORS_ORIGIN и APP_URL

Теперь, когда домен известен:

1. Перейди на вкладку **«Переменные»**
2. Добавь две новые переменные:
   - `CORS_ORIGIN` = `https://flipbook-ТВОЙЛОГИН.amvera.io`
   - `APP_URL` = `https://flipbook-ТВОЙЛОГИН.amvera.io`
3. Amvera перезапустит контейнер автоматически (или перезапусти вручную)

---

## Часть 3. Проверка

### 3.1. Проверь здоровье сервера

Открой в браузере:
```
https://flipbook-ТВОЙЛОГИН.amvera.io/api/health
```

Если всё ок, увидишь:
```json
{"status": "ok", "checks": {"database": "ok", "storage": "ok"}}
```

Возможные проблемы:
- `database: error` → проверь DATABASE_URL (хост, пароль, имя базы)
- `storage: error` → проверь S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY

### 3.2. Открой сайт

Перейди на:
```
https://flipbook-ТВОЙЛОГИН.amvera.io
```

Должна открыться книжная полка Flipbook!

---

## Часть 4. Обновление

После любых изменений в коде — просто запуши:

```bash
git add .
git commit -m "описание изменений"
git push amvera main
```

Amvera автоматически пересоберёт и перезапустит проект.

---

## Дополнительно

### Google OAuth (опционально)

Если хочешь авторизацию через Google:

1. Открой https://console.cloud.google.com/
2. Создай проект
3. Перейди в APIs & Services → Credentials → Create Credentials → OAuth 2.0 Client ID
4. Добавь в Authorized redirect URIs:
   ```
   https://flipbook-ТВОЙЛОГИН.amvera.io/api/auth/google/callback
   ```
5. Добавь в Amvera переменные:
   - `GOOGLE_CLIENT_ID` = *(Client ID из Google)*
   - `GOOGLE_CLIENT_SECRET` = *(Client Secret из Google)*
   - `GOOGLE_CALLBACK_URL` = `https://flipbook-ТВОЙЛОГИН.amvera.io/api/auth/google/callback`

### Свой домен (опционально)

1. В настройках проекта Amvera нажми **«Добавить домен»**
2. Введи свой домен (например, `flipbook.example.com`)
3. У регистратора домена добавь CNAME-запись:
   ```
   flipbook.example.com → flipbook-ТВОЙЛОГИН.amvera.io
   ```
4. Amvera автоматически выпустит SSL-сертификат
5. Обнови `CORS_ORIGIN` и `APP_URL` на новый домен

### Мониторинг

- **Логи:** вкладка «Лог приложения» в Amvera
- **Статус:** вкладка «Инфо» — состояние контейнера
- **БД:** Prisma Studio не доступна на проде, но можно подключиться через pgAdmin с внешним доменом PostgreSQL (настраивается в Amvera)

---

## Полезные ссылки

- [Amvera Cloud — документация](https://docs.amvera.ru/)
- [Amvera — настройка Docker](https://docs.amvera.ru/applications/configuration/docker.html)
- [Amvera — переменные окружения](https://docs.amvera.ru/applications/configuration/variables.html)
- [Amvera — PostgreSQL](https://docs.amvera.ru/databases/postgreSQL.html)
- [Cloud.ru — Object Storage](https://cloud.ru/docs/s3e/ug/index)
- [Cloud.ru — Free Tier](https://cloud.ru/offers/free-tier)
- [Cloud.ru — создание API-ключа](https://cloud.ru/docs/console_api/ug/topics/guides__static-api-keys__create)
