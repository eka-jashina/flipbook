<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Book – Modular Architecture</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter&family=Roboto&family=Open+Sans&family=Merriweather&family=Libre+Baskerville&display=swap"
      rel="stylesheet"
    />

    <!-- Предзагрузка -->
    <link rel="preload" fetchpriority="high" as="image" href="images/backgrounds/bg-cover.webp" type="image/webp">
    <link rel="preload" href="fonts/tolkiencyr.woff2" as="font" crossorigin="anonymous">

    <!-- Главный CSS (импортирует все модули) -->
    <link rel="stylesheet" href="css/index.css" />
  </head>

<body data-debug="false">
    <!-- Фоновые изображения глав (два слоя для кроссфейда) -->
    <div class="chapter-bg">
      <div class="bg" data-active="false"></div>
      <div class="bg" data-active="false"></div>
    </div>

    <!-- Панель отладки -->
    <div class="debug-info" id="debugInfo">
      <div>State: <span id="debugState">-</span></div>
      <div>Pages: <span id="debugTotal">0</span></div>
      <div>Current: <span id="debugCurrent">0</span></div>
      <div>Cache: <span id="debugCache">0</span></div>
      <div>Memory: <span id="debugMemory">-</span></div>
      <div>Listeners: <span id="debugListeners">0</span></div>
    </div>

    <!-- Error message в HTML-->
    <div class="error-message" id="errorMessage" hidden role="alert">
      <span id="errorText"></span>
    </div>

    <div class="scene">
      <div class="book-wrap" data-state="closed" id="book-wrap">
        <div
          class="book"
          data-state="closed"
          id="book"
          role="region"
          aria-label="Книга"
        >
          <!-- Обложка -->
          <div class="cover" id="cover">
            <div class="cover-front">
              <h1><span>О хоббитах</span> <span>Дж.Р.Р.Толкин</span></h1>
            </div>
            <div class="cover-back"></div>
          </div>

          <!-- Край страниц -->
          <div class="pages-edge" aria-hidden="true"></div>

          <!-- Активные страницы (A-буфер) -->
          <div class="page" data-side="left" data-active="true" id="leftA" aria-live="polite">
            <div class="page-inner"></div>
          </div>
          <div class="page" data-side="right" data-active="true" id="rightA" aria-live="polite">
            <div class="page-inner"></div>
          </div>

          <!-- Буферные страницы (B-буфер) -->
          <div class="page" data-side="left" data-buffer="true" id="leftB" aria-hidden="true">
            <div class="page-inner"></div>
          </div>
          <div class="page" data-side="right" data-buffer="true" id="rightB" aria-hidden="true">
            <div class="page-inner"></div>
          </div>

          <!-- Анимированный лист -->
          <div class="sheet" id="sheet" aria-hidden="true">
            <div class="side" data-face="front" id="sheetFront"></div>
            <div class="side" data-face="back" id="sheetBack"></div>
          </div>

          <div class="flip-shadow" id="flipShadow"></div>

          <!-- Зоны захвата для drag
            В debug режиме ([data-debug="true"]) будут видны -->
          <div class="corner-zone top-right" data-dir="next"></div>
          <div class="corner-zone bottom-right" data-dir="next"></div>
          <div class="corner-zone top-left" data-dir="prev"></div>
          <div class="corner-zone bottom-left" data-dir="prev"></div>

          <!-- Loading overlay с hidden атрибутом -->
          <div class="loading-overlay" id="loadingOverlay" hidden>
            <div class="loading-spinner"></div>
            <div class="loading-progress" id="loadingProgress">Загрузка...</div>
          </div>

          <!-- Измеритель -->
          <div id="measurer"></div>
        </div>
      </div>

      <!-- Панель управления -->
      <div class="controls">
        <div class="navigation">
          <button id="prev">← Назад</button>
          <button id="tocBtn">Содержание</button>
          <button id="next">Вперёд →</button>
          <button id="continueBtn" hidden>Продолжить чтение</button>
          <label>Настройки
            <input class="settings-checkbox" type="checkbox" id="settings-checkbox" />
          </label>
        </div>
        <div class="settings" role="group" aria-label="Настройки чтения">
          <div>
            <div class="font-size">
              <span>Размер шрифта </span>
              <button id="decrease">−</button>
              <button id="increase">+</button>
            </div>
            <div class="font-choice">
              <label for="font-select">Шрифт:</label>
              <select id="font-select">
                <option value="georgia">Georgia</option>
                <option value="merriweather">Merriweather</option>
                <option value="libre-baskerville">Libre Baskerville</option>
                <option value="inter">Inter</option>
                <option value="roboto">Roboto</option>
                <option value="open-sans">Open Sans</option>
              </select>
            </div>
            <div class="theme-choice">
              <label for="theme-select">Тема:</label>
              <select id="theme-select">
                <option value="light">Светлая</option>
                <option value="dark">Тёмная</option>
                <option value="bw">Ч/б</option>
              </select>
            </div>
            <!-- <button id="debugToggle">Debug</button> -->
          </div>
          <!-- Audio Control Pod - объединённая панель звука -->
          <div class="audio-pod">
            <!-- Секция звука перелистывания -->
            <div class="audio-section">
              <div class="audio-section-header">
                <svg class="audio-icon" viewBox="0 0 24 24" width="18" height="18">
                  <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4 14H9c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1h6c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1z"/>
                </svg>
                <span>Перелистывание</span>
              </div>
              <div class="audio-row">
                <label class="toggle-switch">
                  <input type="checkbox" id="sound-toggle" checked />
                  <span class="toggle-slider"></span>
                </label>
                <div class="volume-control" id="page-volume-control">
                  <svg class="vol-icon vol-mute" viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                  </svg>
                  <input
                    type="range"
                    id="volume-slider"
                    min="0"
                    max="100"
                    value="30"
                    class="volume-slider"
                  />
                  <svg class="vol-icon vol-max" viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Секция атмосферных звуков -->
            <div class="audio-section">
              <div class="audio-section-header">
                <svg class="audio-icon" viewBox="0 0 24 24" width="18" height="18">
                  <path fill="currentColor" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                </svg>
                <span>Атмосфера</span>
              </div>
              <div class="ambient-pills" role="radiogroup" aria-label="Выбор фоновой музыки">
                <!-- Pills генерируются из CONFIG.AMBIENT -->
              </div>
              <div class="volume-control ambient-volume-row" id="ambient-volume-wrapper">
                <svg class="vol-icon vol-mute" viewBox="0 0 24 24" width="16" height="16">
                  <path fill="currentColor" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
                <input
                  type="range"
                  id="ambient-volume"
                  min="0"
                  max="100"
                  value="50"
                  class="volume-slider"
                />
                <svg class="vol-icon vol-max" viewBox="0 0 24 24" width="16" height="16">
                  <path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <span>разработка - <a href="https://t.me/layare">@layare</a></span>
          <span>иллюстрации - <a href="https://t.me/nedthird">@nedthird</a></span>
        </div>
      </div>
    </div>

    <!-- ES Module entry point -->
    <script type="module" src="js/index.js"></script>
</body>
</html>
